<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tracker Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#0f62fe;--muted:#6b7280;--bg:#f7fafc}
    html{min-height: 100vh;}
    html,body{height:100%}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:var(--bg); color:#0f1720}
    .navbar{background:#fff;border-bottom:1px solid #e6edf3;padding:18px 16px;display:flex;align-items:center;justify-content:space-between;min-height:64px}
    /* sticky floating navbar */
    .navbar{position:sticky;top:0;z-index:1100;box-shadow:0 6px 18px rgba(12,20,28,0.04)}
    .brand{font-weight:700;color:var(--accent);letter-spacing:0.2px;font-size:18px}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e6edf3;border-radius:10px;padding:18px;box-shadow:0 4px 12px rgba(15,22,32,0.04)}
    .header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;border-radius:8px;border:1px solid transparent;cursor:pointer;font-weight:600;color:#334155}
    .tab.active{background:var(--accent);color:#fff}
    .controls{display:flex;gap:8px;align-items:center}
    .search{padding:10px 12px;border-radius:8px;border:1px solid #e6edf3;width:360px}
    .search:focus{outline:none;box-shadow:0 0 0 3px rgba(15,98,254,0.08);border-color:var(--accent)}
    .meta{color:var(--muted);font-size:13px}
    .table-wrap{overflow-x:auto;-webkit-overflow-scrolling:touch;margin-top:8px}
    table{width:100%;border-collapse:collapse;margin-top:8px;min-width:1100px}
    th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left}
    thead th{font-size:13px;color:#334155;font-weight:600}
    tbody tr:hover{background:#fbfcfe}
    .footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px;padding:18px}
    .pill{background:#eef6ff;color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:600}
    @media (max-width:900px){ .search{width:100%} .container{padding:0 12px} }
  </style>
</head>
  <body>
  <div class="navbar">
    <div class="brand">VisitTracker</div>
    <div class="nav-right">
      <a href="#" style="margin-right:12px;color:#374151;text-decoration:none;font-weight:600">Dashboard</a>
      <a href="#" id="docsLink" style="margin-right:12px;color:#374151;text-decoration:none;cursor:pointer">Docs</a>
    </div>
  </div>

  <div class="container">
    <div class="card">
      <div class="header-row">
        <div style="display:flex;align-items:center;gap:14px">
          <div class="pill">Admin
            <div style="font-weight:700;font-size:18px">Tracker Admin</div>
          </div>
        </div>
        <div class="meta">Realtime · <span id="status">&nbsp;</span></div>
      </div>

      <div style="display:flex;align-items:center;justify-content:space-between;margin-bottom:12px">
        <div class="tabs">
          <div id="tab-messages" class="tab active">Messages</div>
          <div id="tab-trackers" class="tab">Trackers</div>
        </div>
        <div class="controls">
          <input id="search" class="search" placeholder="Search messages, urls, geo (city, country, org)..." />
          <select id="sort" style="padding:10px;border-radius:8px;border:1px solid #e6edf3"><option value="desc">Date desc</option><option value="asc">Date asc</option></select>
        </div>
      </div>

      <div id="content"></div>
    </div>
    <div class="footer">&copy; 2025 <strong class="brand">VisitTracker</strong> — Simple, elegant tracking for founders.</div>
  <!-- Docs modal -->
  <div id="docsModal" style="display:none;position:fixed;inset:0;z-index:1300">
    <div id="docsOverlay" style="position:absolute;inset:0;background:rgba(10,15,25,0.45)"></div>
    <div style="position:relative;max-width:900px;margin:6vh auto;background:#fff;border-radius:12px;padding:20px;box-shadow:0 10px 40px rgba(2,6,23,0.2)">
      <div style="display:flex;justify-content:space-between;align-items:center;margin-bottom:8px">
        <h3 style="margin:0">VisitTracker Docs</h3>
        <button id="docsClose" style="background:#f3f4f6;border:none;padding:6px 10px;border-radius:8px;cursor:pointer">Close</button>
      </div>
      <div style="max-height:60vh;overflow:auto;padding-right:8px">
        <p>Welcome to VisitTracker — quick admin docs and API reference.</p>
        <h4>Quick Tasks</h4>
        <ul>
          <li>Search trackers and messages using the search box (auto-search as you type).</li>
          <li>Sort by date using the dropdown; use pagination at the bottom.</li>
          <li>Tracker records include IP, geo, device, OS, browser and other metadata.</li>
        </ul>
        <h4>API Endpoints</h4>
        <pre style="background:#f8fafc;padding:10px;border-radius:6px">GET /api/trackers?q=&amp;sort=desc|asc&page=1&limit=20
GET /api/messages?q=&amp;sort=desc|asc&page=1&limit=20
POST /send-message { name, email, message }</pre>
        <h4>Environment</h4>
        <p>Set <code>MONGO_URI</code> in your environment (Vercel Environment Variables recommended).</p>
        <h4>Local</h4>
        <pre style="background:#f8fafc;padding:10px;border-radius:6px">npm install
npm start
# Open http://localhost:3000/</pre>
        <h4>Notes</h4>
        <p>The admin UI is static and served from <code>public/index.html</code>. API and tracking are handled by <code>server.js</code>. For large datasets, prefer server-side filters and export as CSV if needed.</p>
      </div>
    </div>
  </div>
  </div>

  <script>
    const state = { tab: 'messages', q:'', sort:'desc', page:1, limit:20 };

    document.getElementById('tab-messages').addEventListener('click',()=>{switchTab('messages')});
    document.getElementById('tab-trackers').addEventListener('click',()=>{switchTab('trackers')});
    const searchEl = document.getElementById('search');
    const statusEl = document.getElementById('status');
    let debounceTimer = null;
    searchEl.addEventListener('input', (e) => {
      state.q = e.target.value;
      state.page = 1;
      statusEl.textContent = 'Typing...';
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>{ statusEl.textContent = 'Searching...'; load(); }, 350);
    });
    document.getElementById('sort').addEventListener('change',e=>{state.sort=e.target.value; state.page=1; load();});

    function switchTab(tab){ state.tab=tab; document.getElementById('tab-messages').classList.toggle('active', tab==='messages'); document.getElementById('tab-trackers').classList.toggle('active', tab==='trackers'); state.page=1; load(); }

    function renderTable(columns, rows){
      const tbl = ['<table>'];
      tbl.push('<thead><tr>'+columns.map(c=>`<th class="${c.sortable? 'sortable':''}" data-field="${c.field}">${c.title}</th>`).join('')+'</tr></thead>');
      tbl.push('<tbody>');
      for(const r of rows){
        tbl.push('<tr>'+columns.map(c=>`<td>${escapeHtml(getValue(r,c.field))}</td>`).join('')+'</tr>');
      }
      tbl.push('</tbody></table>');
      return tbl.join('');
    }

    function getValue(row, field){
      if (!row) return '';
      if (field === 'geo'){
        const g = row.geo || {};
        const parts = [];
        if (g.city) parts.push(g.city);
        if (g.region) parts.push(g.region);
        if (g.country_name) parts.push(g.country_name);
        const lat = g.latitude !== undefined ? g.latitude : (g.lat || undefined);
        const lon = g.longitude !== undefined ? g.longitude : (g.lon || undefined);
        if (lat !== undefined && lon !== undefined) parts.push(`(${lat}, ${lon})`);
        if (g.org) parts.push(g.org);
        if (g.timezone) parts.push(g.timezone);
        if (g.postal) parts.push(g.postal);
        return parts.join(' | ');
      }
      return (row && (field.split('.').reduce((o,k)=>o?o[k]:undefined,row))) || '';
    }

    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function load(){
      const endpoint = state.tab === 'messages' ? '/api/messages' : '/api/trackers';
      const params = new URLSearchParams({ q: state.q||'', sort: state.sort, page: state.page, limit: state.limit });
      const res = await fetch(endpoint + '?' + params.toString());
      const payload = await res.json();
      const content = document.getElementById('content');
      let html = '';
      if(state.tab==='messages'){
        const cols = [ {title:'Name', field:'name'}, {title:'Email', field:'email'}, {title:'Message', field:'message'}, {title:'Created', field:'created_at'} ];
        html += '<div>Found: '+payload.total+'</div>';
        html += '<div class="table-wrap">' + renderTable(cols, payload.data) + '</div>';
      } else {
        const cols = [
          {title:'IP', field:'ip'},
          {title:'URL', field:'url'},
          {title:'Referrer', field:'referrer'},
          {title:'Device', field:'device.model'},
          {title:'Device Type', field:'device.type'},
          {title:'OS', field:'os.name'},
          {title:'OS Ver', field:'os.version'},
          {title:'Browser', field:'browser.name'},
          {title:'Browser Ver', field:'browser.version'},
          {title:'Geo', field:'geo'},
          {title:'Language', field:'language'},
          {title:'Time', field:'timestamp'}
        ];
        html += '<div>Found: '+payload.total+'</div>';
        html += '<div class="table-wrap">' + renderTable(cols, payload.data) + '</div>';
      }
      // pagination
      html += `<div style="margin-top:8px"><button id="prev">Prev</button> Page ${payload.page} <button id="next">Next</button></div>`;
      content.innerHTML = html;
      document.getElementById('prev').addEventListener('click',()=>{ if(state.page>1){ state.page--; load(); }});
      document.getElementById('next').addEventListener('click',()=>{ state.page++; load(); });
    }

    // initial load
    load();

    // Docs modal handlers
    const docsLink = document.getElementById('docsLink');
    const docsModal = document.getElementById('docsModal');
    const docsClose = document.getElementById('docsClose');
    const docsOverlay = document.getElementById('docsOverlay');
    function openDocs(){ docsModal.style.display='block'; document.body.style.overflow='hidden'; }
    function closeDocs(){ docsModal.style.display='none'; document.body.style.overflow='auto'; }
    if(docsLink) docsLink.addEventListener('click', (e)=>{ e.preventDefault(); openDocs(); });
    if(docsClose) docsClose.addEventListener('click', closeDocs);
    if(docsOverlay) docsOverlay.addEventListener('click', closeDocs);
  </script>

</body>
</html>