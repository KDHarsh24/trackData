<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tracker Admin</title>
  <style>
    body{font-family:Arial,Helvetica,sans-serif;margin:16px}
    .tabs{display:flex;gap:8px;margin-bottom:12px}
    .tab{padding:8px 12px;border:1px solid #ccc;cursor:pointer}
    .tab.active{background:#0070f3;color:#fff}
    .controls{margin-bottom:8px}
    table{width:100%;border-collapse:collapse}
    th,td{padding:8px;border:1px solid #ddd;text-align:left}
    th.sortable{cursor:pointer}
  </style>
</head>
<body>
  <h2>Tracker Admin</h2>
  <div class="tabs">
    <div id="tab-messages" class="tab active">Messages</div>
    <div id="tab-trackers" class="tab">Trackers</div>
  </div>

  <div class="controls">
    <input id="search" placeholder="Search..." style="width:320px;padding:6px" />
    <select id="sort"><option value="desc">Date desc</option><option value="asc">Date asc</option></select>
    <button id="btnSearch">Search</button>
  </div>

  <div id="content"></div>

  <script>
    const state = { tab: 'messages', q:'', sort:'desc', page:1, limit:20 };

    document.getElementById('tab-messages').addEventListener('click',()=>{switchTab('messages')});
    document.getElementById('tab-trackers').addEventListener('click',()=>{switchTab('trackers')});
    document.getElementById('btnSearch').addEventListener('click',()=>{state.q=document.getElementById('search').value; state.page=1; load();});
    document.getElementById('sort').addEventListener('change',e=>{state.sort=e.target.value; state.page=1; load();});

    function switchTab(tab){ state.tab=tab; document.getElementById('tab-messages').classList.toggle('active', tab==='messages'); document.getElementById('tab-trackers').classList.toggle('active', tab==='trackers'); state.page=1; load(); }

    function renderTable(columns, rows){
      const tbl = ['<table>'];
      tbl.push('<thead><tr>'+columns.map(c=>`<th class="${c.sortable? 'sortable':''}" data-field="${c.field}">${c.title}</th>`).join('')+'</tr></thead>');
      tbl.push('<tbody>');
      for(const r of rows){
        tbl.push('<tr>'+columns.map(c=>`<td>${escapeHtml(getValue(r,c.field))}</td>`).join('')+'</tr>');
      }
      tbl.push('</tbody></table>');
      return tbl.join('');
    }

    function getValue(row, field){
      if (!row) return '';
      if (field === 'geo'){
        const g = row.geo || {};
        const parts = [];
        if (g.city) parts.push(g.city);
        if (g.region) parts.push(g.region);
        if (g.country_name) parts.push(g.country_name);
        const lat = g.latitude !== undefined ? g.latitude : (g.lat || undefined);
        const lon = g.longitude !== undefined ? g.longitude : (g.lon || undefined);
        if (lat !== undefined && lon !== undefined) parts.push(`(${lat}, ${lon})`);
        if (g.org) parts.push(g.org);
        if (g.timezone) parts.push(g.timezone);
        if (g.postal) parts.push(g.postal);
        return parts.join(' | ');
      }
      return (row && (field.split('.').reduce((o,k)=>o?o[k]:undefined,row))) || '';
    }

    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function load(){
      const endpoint = state.tab === 'messages' ? '/api/messages' : '/api/trackers';
      const params = new URLSearchParams({ q: state.q||'', sort: state.sort, page: state.page, limit: state.limit });
      const res = await fetch(endpoint + '?' + params.toString());
      const payload = await res.json();
      const content = document.getElementById('content');
      let html = '';
      if(state.tab==='messages'){
        const cols = [ {title:'Name', field:'name'}, {title:'Email', field:'email'}, {title:'Message', field:'message'}, {title:'Created', field:'created_at'} ];
        html += '<div>Found: '+payload.total+'</div>';
        html += renderTable(cols, payload.data);
      } else {
        const cols = [ {title:'IP', field:'ip'}, {title:'URL', field:'url'}, {title:'Referrer', field:'referrer'}, {title:'UA', field:'userAgent'}, {title:'Geo', field:'geo'}, {title:'Language', field:'language'}, {title:'Time', field:'timestamp'} ];
        html += '<div>Found: '+payload.total+'</div>';
        html += renderTable(cols, payload.data);
      }
      // pagination
      html += `<div style="margin-top:8px"><button id="prev">Prev</button> Page ${payload.page} <button id="next">Next</button></div>`;
      content.innerHTML = html;
      document.getElementById('prev').addEventListener('click',()=>{ if(state.page>1){ state.page--; load(); }});
      document.getElementById('next').addEventListener('click',()=>{ state.page++; load(); });
    }

    // initial load
    load();
  </script>
</body>
</html>