<!doctype html>
<html>
<head>
  <meta charset="utf-8" />
  <meta name="viewport" content="width=device-width,initial-scale=1" />
  <title>Tracker Admin</title>
  <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;600;700&display=swap" rel="stylesheet">
  <style>
    :root{--accent:#0f62fe;--muted:#6b7280;--bg:#f7fafc}
    html,body{height:100%}
    body{font-family:Inter, system-ui, -apple-system, 'Segoe UI', Roboto, 'Helvetica Neue', Arial; margin:0; background:var(--bg); color:#0f1720}
    .navbar{background:#fff;border-bottom:1px solid #e6edf3;padding:12px 24px;display:flex;align-items:center;justify-content:space-between}
    .brand{font-weight:700;color:var(--accent);letter-spacing:0.2px}
    .container{max-width:1100px;margin:28px auto;padding:0 16px}
    .card{background:#fff;border:1px solid #e6edf3;border-radius:10px;padding:18px;box-shadow:0 4px 12px rgba(15,22,32,0.04)}
    .header-row{display:flex;align-items:center;justify-content:space-between;margin-bottom:12px}
    .tabs{display:flex;gap:8px}
    .tab{padding:8px 12px;border-radius:8px;border:1px solid transparent;cursor:pointer;font-weight:600;color:#334155}
    .tab.active{background:var(--accent);color:#fff}
    .controls{display:flex;gap:8px;align-items:center}
    .search{padding:10px 12px;border-radius:8px;border:1px solid #e6edf3;width:360px}
    .search:focus{outline:none;box-shadow:0 0 0 3px rgba(15,98,254,0.08);border-color:var(--accent)}
    .meta{color:var(--muted);font-size:13px}
    table{width:100%;border-collapse:collapse;margin-top:8px}
    th,td{padding:10px;border-bottom:1px solid #f1f5f9;text-align:left}
    thead th{font-size:13px;color:#334155;font-weight:600}
    tbody tr:hover{background:#fbfcfe}
    .footer{margin-top:18px;text-align:center;color:var(--muted);font-size:13px;padding:18px}
    .pill{background:#eef6ff;color:var(--accent);padding:6px 10px;border-radius:999px;font-weight:600}
    @media (max-width:900px){ .search{width:100%} .container{padding:0 12px} }
  </style>
</head>
<body>
  <h2>Tracker Admin</h2>
  <div class="tabs">
    <div id="tab-messages" class="tab active">Messages</div>
    <div id="tab-trackers" class="tab">Trackers</div>
  </div>

  <div class="controls">
    <input id="search" class="search" placeholder="Search messages, urls, geo (city, country, org)..." />
    <select id="sort" style="padding:10px;border-radius:8px;border:1px solid #e6edf3"><option value="desc">Date desc</option><option value="asc">Date asc</option></select>
    <div id="status" class="meta">&nbsp;</div>
  </div>

  <div id="content"></div>

  <script>
    const state = { tab: 'messages', q:'', sort:'desc', page:1, limit:20 };

    document.getElementById('tab-messages').addEventListener('click',()=>{switchTab('messages')});
    document.getElementById('tab-trackers').addEventListener('click',()=>{switchTab('trackers')});
    const searchEl = document.getElementById('search');
    const statusEl = document.getElementById('status');
    let debounceTimer = null;
    searchEl.addEventListener('input', (e) => {
      state.q = e.target.value;
      state.page = 1;
      statusEl.textContent = 'Typing...';
      clearTimeout(debounceTimer);
      debounceTimer = setTimeout(()=>{ statusEl.textContent = 'Searching...'; load(); }, 350);
    });
    document.getElementById('sort').addEventListener('change',e=>{state.sort=e.target.value; state.page=1; load();});

    function switchTab(tab){ state.tab=tab; document.getElementById('tab-messages').classList.toggle('active', tab==='messages'); document.getElementById('tab-trackers').classList.toggle('active', tab==='trackers'); state.page=1; load(); }

    function renderTable(columns, rows){
      const tbl = ['<table>'];
      tbl.push('<thead><tr>'+columns.map(c=>`<th class="${c.sortable? 'sortable':''}" data-field="${c.field}">${c.title}</th>`).join('')+'</tr></thead>');
      tbl.push('<tbody>');
      for(const r of rows){
        tbl.push('<tr>'+columns.map(c=>`<td>${escapeHtml(getValue(r,c.field))}</td>`).join('')+'</tr>');
      }
      tbl.push('</tbody></table>');
      return tbl.join('');
    }

    function getValue(row, field){
      if (!row) return '';
      if (field === 'geo'){
        const g = row.geo || {};
        const parts = [];
        if (g.city) parts.push(g.city);
        if (g.region) parts.push(g.region);
        if (g.country_name) parts.push(g.country_name);
        const lat = g.latitude !== undefined ? g.latitude : (g.lat || undefined);
        const lon = g.longitude !== undefined ? g.longitude : (g.lon || undefined);
        if (lat !== undefined && lon !== undefined) parts.push(`(${lat}, ${lon})`);
        if (g.org) parts.push(g.org);
        if (g.timezone) parts.push(g.timezone);
        if (g.postal) parts.push(g.postal);
        return parts.join(' | ');
      }
      return (row && (field.split('.').reduce((o,k)=>o?o[k]:undefined,row))) || '';
    }

    function escapeHtml(s){ if(s===null||s===undefined) return ''; return String(s).replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;'); }

    async function load(){
      const endpoint = state.tab === 'messages' ? '/api/messages' : '/api/trackers';
      const params = new URLSearchParams({ q: state.q||'', sort: state.sort, page: state.page, limit: state.limit });
      const res = await fetch(endpoint + '?' + params.toString());
      const payload = await res.json();
      const content = document.getElementById('content');
      let html = '';
      if(state.tab==='messages'){
        const cols = [ {title:'Name', field:'name'}, {title:'Email', field:'email'}, {title:'Message', field:'message'}, {title:'Created', field:'created_at'} ];
        html += '<div>Found: '+payload.total+'</div>';
        html += renderTable(cols, payload.data);
      } else {
        const cols = [ {title:'IP', field:'ip'}, {title:'URL', field:'url'}, {title:'Referrer', field:'referrer'}, {title:'UA', field:'userAgent'}, {title:'Geo', field:'geo'}, {title:'Language', field:'language'}, {title:'Time', field:'timestamp'} ];
        html += '<div>Found: '+payload.total+'</div>';
        html += renderTable(cols, payload.data);
      }
      // pagination
      html += `<div style="margin-top:8px"><button id="prev">Prev</button> Page ${payload.page} <button id="next">Next</button></div>`;
      content.innerHTML = html;
      document.getElementById('prev').addEventListener('click',()=>{ if(state.page>1){ state.page--; load(); }});
      document.getElementById('next').addEventListener('click',()=>{ state.page++; load(); });
    }

    // initial load
    load();
  </script>

  <div class="footer">&copy; 2025 <strong class="brand">VisitTracker</strong> — Simple, elegant tracking for founders.<br/>Built with ♥ for fast debugging and analysis.</div>
</body>
</html>